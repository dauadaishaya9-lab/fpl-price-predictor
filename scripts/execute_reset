import json
import os
import shutil
from datetime import datetime

RESET_FILE = "data/reset_request.json"
DATA_DIR = "data"

def log(msg):
    print(f"[RESET] {msg}")

def load_reset_request():
    if not os.path.exists(RESET_FILE):
        return None
    try:
        with open(RESET_FILE, "r") as f:
            return json.load(f)
    except Exception as e:
        log(f"Failed to read reset file: {e}")
        return None

def clear_reset_request():
    os.remove(RESET_FILE)
    log("Reset request cleared")

def wipe_file(path):
    if os.path.exists(path):
        os.remove(path)
        log(f"Deleted {path}")

def wipe_dir(path):
    if os.path.exists(path):
        shutil.rmtree(path)
        log(f"Deleted directory {path}")

def execute_reset(reset):
    reset_type = reset.get("type")
    timestamp = reset.get("timestamp", "unknown")

    log(f"Executing reset type: {reset_type} (requested at {timestamp})")

    if reset_type == "full":
        wipe_dir(f"{DATA_DIR}/snapshots")
        wipe_file(f"{DATA_DIR}/thresholds.json")
        wipe_file(f"{DATA_DIR}/velocity.csv")
        wipe_file(f"{DATA_DIR}/trends.csv")
        wipe_file(f"{DATA_DIR}/predictions.csv")

    elif reset_type == "snapshots":
        wipe_dir(f"{DATA_DIR}/snapshots")

    elif reset_type == "thresholds":
        wipe_file(f"{DATA_DIR}/thresholds.json")

    elif reset_type == "predictions":
        wipe_file(f"{DATA_DIR}/predictions.csv")

    elif reset_type == "soft":
        # Soft reset = learning memory only
        wipe_file(f"{DATA_DIR}/velocity.csv")
        wipe_file(f"{DATA_DIR}/trends.csv")

    else:
        log(f"Unknown reset type: {reset_type}")
        return

    log("Reset execution completed")

def main():
    reset = load_reset_request()

    if not reset:
        log("No reset requested")
        return

    # Optional safety: expiry (e.g. 1 hour)
    if "expires_at" in reset:
        expires = datetime.fromisoformat(reset["expires_at"])
        if datetime.utcnow() > expires:
            log("Reset request expired")
            clear_reset_request()
            return

    execute_reset(reset)
    clear_reset_request()

if __name__ == "__main__":
    main()
